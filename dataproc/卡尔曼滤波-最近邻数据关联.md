## 卡尔曼滤波-最近邻数据关联

### 1. 为什么做数据关联
如果对目标的测量时雷达只采集到唯一量测值（在二维运动的例子中，雷达只得到唯一的目标 $x$ 和 $y$ 值），那么可以用卡尔曼滤波的方法对目标的量测值进行滤波得到最优解。但是实际情况中，雷达会采集到很多个测量值，这些测量值可能是杂波造成的，也可能是其他目标造成的。这个时候，雷达返回了很多量测值，无法直接判断出哪个是目标产生的，哪些是杂波造成的，所以必须得使用一种策略，能够从采集到的众多值中得到如何从采集到的众多值中得到一个合适的值，该值就是当前时刻目标的量测值（即 $z_{measure}$ ），这个策略就是数据关联。

具体的说，雷达采集到的量测值 $z_{candi}$ 从 $z_1$ 到 $z_n$ 共有 $n$ 个，我们不能直接判断出哪一个是目标的量测值。

$z_{candi}=\begin{bmatrix}
z_1 \\
z_2 \\
... \\
z_n
\end{bmatrix}$

所以，需要数据关联方法 $f_a$ ，通过数据关联方法，得到对该目标最佳的量测值 $z_{measure}$ ，即：

$$z_{measure} = f_a(z_{candi})$$


### 2. 数据关联和卡尔曼滤波联合运用

卡尔曼滤波中关键的步骤是将预测的状态值 $x_{pred}$ 和当前时刻的量测值 $z_{measure}$ 利用卡尔曼增益进行融合，得到该时刻目标状态值的最优估计 $x_k$ ，即公式： $x_{k}=x_{pred}+K_k(z_{meansure}-Hx_{pred})$ 。
在这个公式中， $z_{measure}$ 表示的是单一雷达对单一目标的唯一量测值，但是正如第1节中所述，实际上单一雷达对单一目标测量时，很可能得到多个量测值 $z_{candi}$ ，所以，需要通过数据关联方法 $f_a$ 将 $z_{candi}$ 变为 唯一量测值 $z_{measure}$ 才可以正常使用卡尔曼滤波。

#### 2.1 如何得到 $z_{candi}$
根据第1、2节所述，对于单目标有杂波的跟踪任务，如果我能够知道 $z_{candi}$ ，通过合适的卡尔曼滤波方法，加上合适的数据关联方法，那么就可以解决该问题。 $z_{candi}$ 的选择表面上看不是问题，雷达测到多少量测值，就把这些量测值都纳入 $z_{candi}$ 中，但是很明显，雷达测量结果中出现了很明显的离群值，这个值可能是在雷达视野内但是距离跟踪目标很远的其他物体，那么这个值应当被舍弃，所以，$z_{candi}$ 的选择实际上存在阈值。
具体的， $z_{candi}$ 中的量测值应当在 $z_{pred}$ 附近某个范围内，或者说 $z_{candi}$ 到 $z_{pred}$ 的距离小于某个值 $\gamma$。这里计算两点之间的距离，一般不使用欧氏距离，而是使用马氏距离。
#### 2.2 为什么使用马氏距离？
欧氏距离适用于各向同性且维度无关的情况，而马氏距离考虑了数据的协方差结构，适用于各维度具有不同方差和相关性的情况。
例如，跟踪的目标是个螃蟹，螃蟹在两个 $x$ 和 $y$ 移动的误差协方差不同，螃蟹沿着 $x$ 轴移动误差是10cm，沿着 $y$ 轴移动误差是1cm，那么假如当前的 $z_{pred} = [0,0]^T$，那么位置在(5,0)和(0,5)的两个点到(0,0)的欧氏距离虽然相同，但是对于螃蟹运动而言，很明显(0,5)这个点更像一个异常值。
这是二维平面运动的例子，如果除了量测值既有距离又有速度，两个不同量纲的物理量更无法用欧氏距离。马氏距离是在考虑了不同维度的协方差的情况下，判断2个向量的相似程度。
#### 2.3 如何计算马氏距离？
计算 $z_{candi}$ 中 $z_i$ 到 $z_{pred}$ 的马氏距离公式为：

$$(z_i-z_{pred})'S^{-1}(z_i-z_{pred})$$

在卡尔曼滤波那一篇已经介绍过，上式中的 $S$ 就是的新息协方差， $z_i-z_{pred}$ 就是第 $i$ 个量测值的新息向量 $V_i$ 。即有下式：

$$V'SV< \gamma$$

这里的 $\gamma$ 称为波门，满足上式的所有量测值称为在波门内。利用马氏距离确定的波门是椭圆波门。之所以是椭圆波门，因为当 $V'SV= \gamma$ 时，所有的 $z_i$ 在直角坐标系中围成一个椭圆，在该椭圆门内的点也就满足上式，故而称为椭圆波门。除了椭圆波门，还有环形玻门、矩形波门。

至此，就可以计算雷达得到的所有量测值到预测量测值的马氏距离，同时选择一个合适的 $\gamma$ ，判断出哪些点属于 $z_{candi}$ 
#### 2.4 波门阈值 $\gamma$ 的选择
对于椭圆波门而言，不同 $\gamma$ 对应的真实量测值（对目标的量测值）落入波门内的概率 $P_G$ 是可以计算得到的。下表是对于不同维度的量测值，选取不同 $\gamma$ 值时，真实值落入波门内的概率。
![gamma-PG.png][https://github.com/dangoess/mmw-radar-algorithm/blob/main/pic/gamma_pg.png]
对于二维平面目标跟踪而言。 $n_z$为2，当 $\gamma = 16$ 时， 真实量测值落入波门的概率为0.9997。

#### 2.5 小节
1. 想利用卡尔曼滤波就要知道 $z_{measure}$ ；
2. 想得到 $z_{measure}$ 就要知道 $z_{candi}$ ；
3. 想得到 $z_{candi}$ 就要知道哪些量测值落入波门内；
4. 想要判断哪些量测值落入波门内，就需要计算所有量测值到预测量测值的马氏距离，并且用 $\gamma$ 确定波门大小

### 3.代码分析

代码见：kalmanfilter_nn.m
## 参考
基于数据关联算法的汽车主动防撞预警系统多目标跟踪研究_李秋燕
