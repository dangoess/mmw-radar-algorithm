## 卡尔曼滤波
### 1. 算法功能
用传感器测量某物理量时，预测该物理量的当前值。例如：毫米波雷达测量目标的位置，卡尔曼滤波可以预测目标当前时刻的位置。
### 2. 核心思想
卡尔曼滤波可以分为2个阶段，预测阶段和更新阶段：
1. 利用历史信息得到当前位置**预测**值：由于目标位置基本不会突变，根据历史位置预测得到的当前位置可以减小当前时刻不合理的量测值带来的影响。
    - 例如：用上一时刻的位置，使用公式路程( $z$ )=速度( $v$ )×时间( $t$ )(即 $z=vt$ ) 预测出当前位置。这里只用了上一时刻的位置是因为上一时刻的位置也是根据上上一时刻的位置得到的，所以只要参考上一时刻的位置，其实就包含了所有的历史位置，这是一个迭代的过程，上一次迭代的结果就包携带了所有历史迭代结果的信息。
2. 利用当前量测**更新**1中得到的预测值：目标当前位置的测量值包含了目标在当前时刻的真实变化信息，所以利用该量测值去更新1中得到的预测值，这个更新值就同时包含了历史位置和当前信息，可以认为这个更新后的值即是当前时刻目标位置的最优估计值。
    - 例如：已知上一时刻的速度和位置，推算出当前时刻的位置 $z_{pred}$ ，又知道当前雷达测得的目标位置为 $z_{measure}$ ，那当前目标位置的最优估计应该是 $z_{opt} = W_1z_{pred}+W_2z_{measure}$ ，其中， $W_1$ 和 $W_2$ 就是权重，用来衡量预测值和当前量测值对最优估计值的影响。如果历史估计很准确，那么 $W_2$ 就趋近于0，则 $z_{opt} = W_1z_{pred}$ ，反之，如果历史估计不准确（或者说雷达测量很准确），那么 $W_2$ 就可以取一个很大的值，此时 $z_{opt} = W_2z_{measure}$ 。
### 3. 公式
根据核心思想中的分析，卡尔曼滤波的2个阶段分别对应以下5个公式，其中预测阶段2个公式，更新阶段3个公式：
- 预测公式

$$x_{pred}=Ax_{k-1}+Bu_{k-1}$$
$$P_{pred}=AP_{k-1}A^{T}+Q$$
-  更新公式
  
$$K_k=\frac{P_{pred}H^{T}}{HP_{pred}H^{T}+R}$$
$$x_{k}=x_{pred}+K_k(Z_{meansure}-Hx_{pred})$$
$$P_k=(I-K_kH)P_{pred}$$

    
#### 3.1符号说明
- 公式中的符号
    
    $x_{pred}$：预测状态值
    
    $x_{k}$：当前时刻（$k$时刻），卡尔曼滤波后的状态值
    
    $x_{k-1}$：上一时刻（$k$-1时刻），卡尔曼滤波后的状态值
    
    $z_{measure}$：雷达测量得到量测值
    
    $P_{pred}$：预测误差协方差
    
    $P_k$：当前时刻，卡尔曼滤波后的误差协方差
    
    $P_{k-1}$：上一时刻，卡尔曼滤波后的误差协方差
    
    $u_{k-1}$：上一时刻，系统的外部控制量
    
    $A$：状态转移矩阵，从上一时刻的状态值到下一时刻的状态值所进行的线性变换的矩阵
    
    $B$：输入控制矩阵，从上一时刻的状态值到下一时刻的状态值变换过程中外界施加的控制信号（这个描述感觉很抽象，到具体的例子中则容易理解）
    
    $H$：观测矩阵，从状态值到观测值的线性变换矩阵
    
    $Q$：预测噪声协防差矩阵，描述了系统状态转移中的误差，理论上可以通过多次测量进行统计
    
    $R$：观测噪声协方差矩阵，描述了观测值的误差，例如传感器的测量误差，理论上可以通过多次测量进行统计

- 公式以外的符号(代码中或者之后的算法会用到)

    $z_{pred}$：预测的量测值
    
    $z_{k}$：当前时刻（$k$时刻），卡尔曼滤波后的量测值，也是整个卡尔曼滤波输出的结果，即目标的最优估计值
    
    $V$：新息向量，所谓的新息指的是量测值和预测的量测值的差，即$z_{pred}-z_{measure}$
    
    $S$：新息协方差，表征了预测的量测值的协方差，可以认为初始的新息协方差解释观测噪声协方差矩阵$R$（字面理解很抽象，需要结合例子理解）

- 术语说明：
    1. 状态值：通常用 $X$ 相关的符号表示，含义是目标当前的状态，例如：目标的位置 $x$ 和速度 $v$ 
    2. 量测值：通常用 $Z$ 相关的符号表示，含义是传感器给出的测量结果，例如：雷达测得目标位置（这里没有涉及速度，因为速度跟踪是非线性系统，之后会分析速度跟踪）
    3. 误差协方差：通常用 $P$ 相关的符号表示，表示各个状态值误差的协方差。后面代码中会详细分析。
    
### 4. 公式分析
以目标在二维平面运动时，对目标的位置做卡尔曼滤波为例进行分析。 $x,v_x,y,v_y$ 分别表示目标在二维平面运动时， X方向位移量 $x$， X方向速度 $v_x$ ， Y方向位移量 $y$ ， Y方向速度 $v_y$ 。
#### 已知量
1.  $z_{measure}(k)$ ，雷达当前时刻（ $k$ 时刻）的量测值，有 $z_{measure}(k)=[x,y]^T$
2.  $A$ ， $B$ 和 $H$ ，需要预先知道状态转移矩阵和输入控制矩阵，对于二维平面运动的目标
$A$通常为： $A=\begin{bmatrix} 1 & dt & 0 & 0 \\ 0 & 1 & 0 & 0 \\0 & 0 & 1 & dt\\0 & 0 & 0 & 1\end{bmatrix}$
$B$通常为： $B=\begin{bmatrix} 0.5dt^2 & 0  \\ dt & 0  \\ 0 & 0.5dt^2 \\0 & 1\end{bmatrix}$
$H$通常为： $H=\begin{bmatrix} 1 & 0 & 0 & 0 \\ 0 & 0 & 1 & 0 \end{bmatrix}$
其中， $dt$ 表示2次测量的时间间隔。
3.  $R$ 和 $Q$ ，需要预先知道预测噪声协方差和观测噪声协方差，这两个值是先验的值，是根据统计和经验得到的，在实际应用中具体如何确定这两个值，需要进行额外的讨论。
            
#### 公式1： $x_{pred}=Ax_{k-1}+Bu_{k-1}$
该公式的目的是得到预测状态值 $x_{pred}$ ，正如**核心思想**第1阶段所述，需要根据上一时刻的值得到当前时刻的预测值，具体的：
$$x_{pred} = [x,v_x,y,v_y]^T$$
$$x_{k-1} = [x_{k-1},v_{x_{k-1}},y_{k-1},v_{y_{k-1}}]^T$$
因为：
当前位置 = 上一时刻位置+速度×时间+0.5×时间的平方×加速度
当前速度 = 上一时刻速度+加速度×时间+时间×加速度
$$x=x_{k-1}+v_{x_{k-1}}·dt+0.5dt^2·u_{k-1}$$
$$v_x=v_{x_{k-1}}+dt·u_k$$
$$y=y_{k-1}+v_{y_{k-1}}·dt+0.5dt^2·u_{k-1}$$
$$v_y=v_{y_{k-1}}+dt·u_k$$
将上述4个式子写成矩阵：
$$\begin{bmatrix} x \\ v_x \\y\\v_y\end{bmatrix}=
\begin{bmatrix} 1 & dt & 0 & 0 \\ 0 & 1 & 0 & 0 \\0 & 0 & 1 & dt\\0 & 0 & 0 & 1\end{bmatrix}·
\begin{bmatrix} x_{k-1} \\ v_{x_{k-1}} \\y_{k-1}\\v_{y_{k-1}}\end{bmatrix}+
\begin{bmatrix} 0.5dt^2 & 0 \\ dt & 0 \\ 0 & 0.5dt^2 \\0 & 1\end{bmatrix}·
u_{k-1}
$$
即得到：
$$x_{pred}=Ax_{k-1}+Bu_{k-1}$$
至此，已经得到状态量的预测值，但是需要注意的是，目前得到的预测值的状态量$x_{pred}$并不是位置的预测的量测值$z_{pred}$。$z_{pred}$是根据$x_{pred}$得到的，在该例子中：
$$z_{pred}=[x,y]^T$$
即：
$$[x,y]^T=\begin{bmatrix} 1 & 0 & 0 & 0 \\ 0 & 0 & 1 & 0 \end{bmatrix}·
\begin{bmatrix} x_{k-1} \\ v_{x_{k-1}} \\y_{k-1}\\v_{y_{k-1}}\end{bmatrix}
$$
则：
$$z_{pred} = Hx_{pred}$$
其实，该公式真正需要得到的是$z_{pred}$，然后再将$z_{pred}$和$z_{measure}$融合就可以得到对目标位置的最优估计。

#### 公式2：$P_{pred}=AP_{k-1}A^{T}+Q$
该公式的目的是计算误差协防差矩阵，误差协方差是各个状态量之间的协方差矩阵。计算误差协方差的原因是通过误差协方差矩阵来更新卡尔曼增益。在**核心思想**第2点中，需要权重来衡量预测值和量测值对于最优估计的贡献，这里的误差协方差矩阵就是计算权重的参考因素之一。
P的初始值：
    1.P的初始值可以是单位对角阵$P_0=I$
    2.P的初始值可以是$P_0=\begin{bmatrix}
R_{11} & R_{11}/dt & R_{12} & R_{12}/dt \\
R_{11}/dt & 2R_{11}/dt^2 & R_{12}/dt & 2R_{12}/dt^2\\
R_{21} & R_{21}/dt& R_{22}& R_{22}/dt\\
R_{21}/dt & 2R_{21}/dt^2 & R_{22}/dt & 2R_{22}/dt^2 
\end{bmatrix}
$
其中$R_{11}$是状态量$x$的方差，$R_{22}$是状态量$y$的方差，$R_{12}$是状态量$x$和$y$的协方差，$R_{21}$是状态量$y$和$x$的协方差。通常$R_{11}$和$R_{22}$由观测噪声协方差$R$确定，$R_{12}$和$R_{21}$为0。
#### 公式3：$K_k=\frac{P_{pred}H^{T}}{HP_{pred}H^{T}+R}$
该公式计算出卡尔曼增益，卡尔曼增益就是**核心思想**第2点中的权重，只不过**核心思想**中加权方式和卡尔曼滤波的加权方式不同，卡尔曼滤波的加权方式只需要一个权重，具体的加权方式在公式4中介绍。

在公式3中，可以得到新息协方差矩阵$S = HP_{pred}H^{T}$，根据公式2中对$P_0$的分析，初始的新息协方差矩阵$S_0=\begin{bmatrix} 
R_{11} & R_{12} \\
R_{21} & R_{22}
\end{bmatrix}$。随着卡尔曼滤波的不断尽心，$S$也在不断更新，$S$就代表了当前时刻量测值$x和y$的误差协方差。
#### 公式4：$x_{k}=x_{pred}+K_k(Z_{meansure}-Hx_{pred})$
该公式的目的是将上一时刻的预测值和当前时刻的量测值通过卡尔曼增益进行融合，计算出目标当前时刻量测值的最优估计。正如**核心思想**中第2点所述，将历史信息和当前新息进行加权融合，这个权值就是卡尔曼增益$K$。

但是，这里融合的方式不是和**核心思想**中第2点所述需要2个权重进行融合的方式完全相同，而是用了一种新的方式。具体的，公式中有$Hx_{pred}$这一项的结果其实就是预测的量测值$z_{pred}$，就是公式1本质上想要得到的结果，即：
$$z_{pred}=Hx_{pred}$$
这里令：
$$V=z_{measure}-z_{pred}$$
$V$就称为新息向量，是量测值和预测的量测值的差，$V$其实就代表了量测值和预测的量测值之间的差距。

公式4其实涉及两个域，一个是状态域（符号与$x$相关），一个是量测域（符号与$z$相关）。在公式4中左侧是$x_k$，这是当前时刻的状态值的卡尔曼滤波的结果（也就是当前时刻状态值的最优估计）。公式4的右侧$x_{pred}+K_k(Z_{meansure}-Hx_{pred})$，这个式子中“$+$”号以前的$x_{pred}$是预测的状态值（状态域），“$+$”号以后的$K_k(Z_{meansure}-Hx_{pred})$是将量测值和预测的量测值做差（得到新息向量$V$），再对这个差再进行加权（乘$K_k$）。其实括号中的$Z_{meansure}-Hx_{pred}$包含了量测和预测的差距（即新息），只不过是在量测域实现的。因此需要把量测域转换到状态域，所以这里的卡尔曼增益$K_k$不仅有加权的作用，还有转换域的作用。而公式中的观察矩阵$H$，实现了从状态域到量测域的转换（具体到二维平面运动的例子，就是把状态值 $[x,v_x,y,v_y]^T$ 中的 $[x,y]^T$ 提取出来）。

整个公式其实可以理解为：卡尔曼滤波得到的最优估计=预测值+权重×新息值。回顾看**核心思想**第2点中描述的融合方法，虽然融合方式不同，但是目的都是为了融合历史信息和当前新息，二者从思想上是为了达到同样的目的，**核心思想**只是为了说明融合的“道”，而不是推导融合公式，分析融合的“术”。

在**核心思想**中描述了权重对最优估计值的影响，而且从公式3中也可以分析出，$K_k$的取值范围实际上是一个开集(0,1)。具体到公式4，当$K_k$的值越靠近0，意味着$R$越大，即当前量测值越不准确，需要依赖历史信息，那么卡尔曼滤波值越不信任新息$V$，反之亦然。

公式4的结果其实就是卡尔曼滤波的结果，如果这是最后一次卡尔曼滤波，那么其实到这里就可以停止了，公式5是为了给下一次卡尔曼滤波做参数更新（卡尔曼滤波就是一个不断迭代的过程）。
#### 公式5：$P_k=(I-K_kH)P_{pred}$
该公式的目的是为下一次卡尔曼滤波做参数更新，更新了误差协方差矩阵，得到$P_k$。下一次卡尔曼滤波计算$P_{pred}$用的就是现在计算得到的$P_k$。所以，$P$在不断更新，$K_k$也随着$P$不断更新，因为$K_k$的值小于1，所以公式5可以看出，$P_k$相对于$P{pred}$实际上是收敛的。

#### 公式总结
按照**核心思想**，卡尔曼滤波的公式可以分为两部分：1.计算预测值；2.预测值和量测值融合。在预测值和量测值融合时，需要得到用来融合的权重。
对应到卡尔曼滤波公式，在公式1中$A$和$B$用来计算预测值；公式2、3、5都是利用$P$、$Q$、$R$得到用来融合的权重$K$；公式4利用$K$对预测值和量测值融合。只是在卡尔曼滤波中，不断更新权重$K$（卡尔曼增益）是依靠不断更新误差协方差矩阵$P$实现的。所以卡尔曼滤波的5个公式可以感性理解为：
1. 计算预测值；
2. 计算$P$；
3. 利用$P$计算$K$；
4. 利用$K$融合预测值和量测值，得到最优估计；
5. 更新$P$，为下一次卡尔曼滤波做准备。

公式中容易混淆的就是状态域（符号$x$相关）和量测域（符号$z$相关），预测的状态值$x_{pred}$、预测的量测值$z_{pred}$、量测值$z_{measure}$、滤波后的状态值$x_k$、滤波后的量测值$z_k$。
### Q和R分析
待更新
### 代码分析
见代码“kalmanfilter.m”

参考：
《卡尔曼滤波原理及应用——MATLAB仿真》黄小平
[滤波笔记一：卡尔曼滤波（Kalman Filtering）详解](https://blog.csdn.net/ouok000/article/details/125578636?spm=1001.2014.3001.5501)

